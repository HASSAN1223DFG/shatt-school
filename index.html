<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© V5.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #111827;
            --sidebar: #1f2937;
            --primary: #d97706; /* Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ ØºØ§Ù…Ù‚ */
            --accent: #f59e0b;  /* Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ ÙØ§ØªØ­ */
            --text: #f3f4f6;
            --glass: rgba(31, 41, 55, 0.7);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { margin: 0; background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle, #1f2937 0%, #000000 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px;
            width: 400px; text-align: center; border: 1px solid var(--primary);
            backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(217, 119, 6, 0.2);
        }

        /* --- Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø§Ù… --- */
        .sidebar {
            width: 280px; background: var(--sidebar); border-left: 1px solid #374151;
            display: flex; flex-direction: column; padding: 20px; transition: 0.3s;
        }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar {
            height: 60px; background: var(--sidebar); border-bottom: 1px solid #374151;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }

        /* --- Ø§Ù„Ø¹Ù†Ø§ØµØ± --- */
        .btn {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: black; border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; margin-top: 10px;
        }
        .btn:hover { transform: scale(1.02); }
        .btn-danger { background: #ef4444; color: white; }
        
        input, select, textarea {
            width: 100%; padding: 12px; margin: 8px 0; background: #374151;
            border: 1px solid #4b5563; color: white; border-radius: 8px; outline: none;
        }
        
        .menu-item {
            padding: 12px; margin: 5px 0; border-radius: 10px; cursor: pointer;
            color: #9ca3af; transition: 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: black; }

        /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
        .page-section { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .active-section { display: block; }

        .chat-box {
            height: calc(100% - 60px); overflow-y: auto; padding: 15px;
            background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px;
        }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 8px; max-width: 80%; width: fit-content; font-size: 0.9rem; }
        .msg.me { background: var(--primary); color: black; margin-right: auto; }
        .msg.other { background: #374151; margin-left: auto; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #4b5563; text-align: center; }
        th { background: #374151; color: var(--accent); }

        /* --- Ù…Ù„Ø§Ø­Ø¸Ø§Øª --- */
        .note-card {
            background: #374151; padding: 10px; margin-bottom: 10px; border-radius: 8px;
            border-right: 4px solid var(--primary);
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <i class="fas fa-graduation-cap fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
        <h2>Ù…Ø¯Ø§Ø±Ø³ Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨</h2>
        <p style="opacity:0.7">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ V5.0</p>
        
        <input type="text" id="log-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="log-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn" onclick="app.login()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
        
        <div style="margin-top:20px; font-size:0.8rem; color:#6b7280; border-top:1px solid #333; padding-top:10px;">
            Ù„Ù„Ø£Ø¯Ù…Ù†: admin / 951357094
        </div>
    </div>
</div>

<div id="app-container" style="display:none; width:100%; height:100%;">
    
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px;">
            <h3 id="u-name" style="color:var(--accent)">Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <span id="u-role" style="background:#374151; padding:2px 10px; border-radius:10px; font-size:0.8rem;"></span>
        </div>

        <div class="menu-item active" onclick="app.nav('dashboard')"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="menu-item" onclick="app.nav('chat')"><i class="fas fa-comments"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        
        <div id="staff-menu" style="display:none;">
            <div class="menu-item" onclick="app.nav('grades')"><i class="fas fa-edit"></i> Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
            <div class="menu-item" onclick="app.nav('notes')"><i class="fas fa-sticky-note"></i> Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ</div>
        </div>
        
        <div id="admin-menu" style="display:none;">
            <div class="menu-item" onclick="app.nav('users')"><i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
            <div class="menu-item" onclick="app.nav('settings')"><i class="fas fa-database"></i> Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>

        <div id="student-menu" style="display:none;">
            <div class="menu-item" onclick="app.nav('my-result')"><i class="fas fa-certificate"></i> Ø´Ù‡Ø§Ø¯ØªÙŠ</div>
        </div>

        <button class="btn btn-danger" onclick="location.reload()" style="margin-top:auto;"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h3 id="page-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
            <div><i class="fas fa-bell" style="color:var(--accent)"></i></div>
        </div>

        <div id="p-dashboard" class="page-section active-section">
            <h1>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨</h1>
            <div style="display:flex; gap:20px; flex-wrap:wrap; margin-top:20px;">
                <div style="flex:1; background:#374151; padding:20px; border-radius:10px;">
                    <h3><i class="fas fa-bullhorn"></i> Ø¢Ø®Ø± Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</h3>
                    <div id="latest-announce" style="font-size:0.9rem; opacity:0.8;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¨Ù„ÙŠØºØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
                </div>
                <div style="flex:1; background:#374151; padding:20px; border-radius:10px;">
                    <h3><i class="fas fa-trophy"></i> Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„</h3>
                    <div id="top-student-name" style="color:var(--accent); font-size:1.2rem; font-weight:bold;">-</div>
                </div>
            </div>
        </div>

        <div id="p-chat" class="page-section">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn" style="width:auto" onclick="app.setRoom('general')">Ø§Ù„Ø¹Ø§Ù…Ø©</button>
                <button class="btn" style="width:auto" onclick="app.setRoom('announce')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
                <button class="btn" style="width:auto" onclick="app.setRoom('staff')" id="btn-staff-chat">ØºØ±ÙØ© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</button>
            </div>
            <h4 id="room-name" style="color:var(--accent)">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
            <div id="chat-display" class="chat-box"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button class="btn" style="width:100px; margin:0;" onclick="app.sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="p-grades" class="page-section">
            <h3>Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
            <input type="text" id="g-st" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…)">
            <select id="g-sub">
                <option>Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ</option><option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                <option>ÙÙŠØ²ÙŠØ§Ø¡</option><option>ÙƒÙŠÙ…ÙŠØ§Ø¡</option><option>Ø£Ø­ÙŠØ§Ø¡</option><option>Ø­Ø§Ø³ÙˆØ¨</option>
                <option>Ø¬Ø±Ø§Ø¦Ù… Ø­Ø²Ø¨ Ø§Ù„Ø¨Ø¹Ø«</option>
            </select>
            <div style="display:grid; grid-template-columns: repeat(5,1fr); gap:5px;">
                <input type="number" id="sc1" placeholder="Ø´1"><input type="number" id="sc2" placeholder="Ø´2">
                <input type="number" id="sc3" placeholder="Ù†ØµÙ"><input type="number" id="sc4" placeholder="Ù2-1">
                <input type="number" id="sc5" placeholder="Ù2-2">
            </div>
            <button class="btn" onclick="app.saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø©</button>
        </div>

        <div id="p-notes" class="page-section">
            <h3>Ø³Ø¬Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
            <input type="text" id="n-st" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
            <textarea id="n-txt" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø³Ù„ÙˆÙƒØŒ ØºÙŠØ§Ø¨ØŒ ØªÙ‚ÙŠÙŠÙ…)..."></textarea>
            <button class="btn" onclick="app.addNote()">Ø¥Ø¶Ø§ÙØ© Ù…ï¿½ï¿½Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø¬Ù„</button>
            <hr style="border-color:#374151; margin:20px 0;">
            <h4>Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚:</h4>
            <div id="notes-list"></div>
        </div>

        <div id="p-users" class="page-section">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="u-new-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="text" id="u-new-user" placeholder="User (Ù„Ù„Ø¯Ø®ÙˆÙ„)">
            <input type="text" id="u-new-pass" placeholder="Pass">
            <select id="u-new-role"><option value="student">Ø·Ø§Ù„Ø¨</option><option value="teacher">Ù…Ø¯Ø±Ø³</option></select>
            <button class="btn" onclick="app.addUser()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            <div id="users-list" style="margin-top:20px;"></div>
        </div>

        <div id="p-settings" class="page-section">
            <h3>ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…</h3>
            <p>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡ ÙÙŠ Ø¬Ù‡Ø§Ø²ÙƒØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø­Ø§Ù„ Ù…Ø³Ø­ Ø§Ù„Ù…ØªØµÙØ­.</p>
            <button class="btn" onclick="app.exportData()" style="background:#10b981;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ù…Ù„Ù)</button>
            <hr>
            <h3>â™»ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <input type="file" id="import-file" style="background:#374151">
            <button class="btn" onclick="app.importData()" style="background:#3b82f6;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù</button>
            <hr>
            <button class="btn btn-danger" onclick="app.resetSystem()">âš ï¸ ØªØµÙÙŠØ± Ø§Ù„Ù…ØµÙ†Ø¹ (Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡)</button>
        </div>

        <div id="p-my-result" class="page-section">
            <div id="cert-print" style="background:white; color:black; padding:30px; border:10px double var(--primary);">
                <div style="text-align:center; border-bottom:2px solid black; padding-bottom:10px;">
                    <h2>Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ - ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©</h2>
                    <h3>Ù…Ø¯Ø§Ø±Ø³ Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</h3>
                    <p>ÙˆØ«ÙŠÙ‚Ø© Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025-2026</p>
                </div>
                <h3 id="cert-name" style="margin-top:20px;">Ø§Ù„Ø·Ø§Ù„Ø¨: </h3>
                <table style="width:100%; border:1px solid black; margin-top:20px;">
                    <thead><tr style="background:#eee;"><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (5 Ø£Ø´Ù‡Ø±)</th><th>Ø§Ù„Ù…Ø¹Ø¯Ù„</th></tr></thead>
                    <tbody id="cert-body"></tbody>
                </table>
                <div style="margin-top:30px; display:flex; justify-content:space-between;">
                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</strong>
                    <div id="cert-notes-area"></div>
                </div>
            </div>
            <button class="btn" onclick="app.printCert()">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
        </div>

    </div>
</div>

<script type="module">
    // Firebase modular imports (CDN)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDjps8vgN3n-TlvJBUW87u_zjhkO_hxCJE",
      authDomain: "shatt-school.firebaseapp.com",
      databaseURL: "https://shatt-school-default-rtdb.firebaseio.com",
      projectId: "shatt-school",
      storageBucket: "shatt-school.firebasestorage.app",
      messagingSenderId: "484274570535",
      appId: "1:484274570535:web:8e780b61c5975ee8e2d502",
      measurementId: "G-LBJHS61HSH"
    };

    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig);
    try { var analytics = getAnalytics(firebaseApp); } catch(e){ /* Analytics may fail on some hosts */ }
    const storage = getStorage(firebaseApp);

    const DB_NAME = 'ShattArabV5_DB';

    const app = {
        data: { users: [], grades: {}, notes: {}, chats: { general:[], announce:[], staff:[] } },
        currentUser: null,
        currentRoom: 'general',
        timer: null,

        init: function() {
            const saved = localStorage.getItem(DB_NAME);
            if(saved) {
                this.data = JSON.parse(saved);
            } else {
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ©
                this.data.users.push({name:'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', user:'admin', pass:'951357094', role:'admin'});
                this.save();
            }
        },

        save: function() {
            localStorage.setItem(DB_NAME, JSON.stringify(this.data));
        },

        login: function() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            const user = this.data.users.find(x => x.user === u && x.pass === p);
            
            if(user) {
                this.currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                document.getElementById('u-name').innerText = user.name;
                document.getElementById('u-role').innerText = user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : (user.role === 'teacher' ? 'Ù…Ø¯Ø±Ø³' : 'Ø·Ø§Ù„Ø¨');
                
                // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                if(user.role === 'admin') document.getElementById('admin-menu').style.display = 'block';
                if(['admin','teacher'].includes(user.role)) document.getElementById('staff-menu').style.display = 'block';
                if(user.role === 'student') {
                    document.getElementById('student-menu').style.display = 'block';
                    document.getElementById('btn-staff-chat').style.display = 'none';
                }

                this.nav('dashboard');
                this.startChatLoop();
            } else {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª');
            }
        },

        nav: function(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-section'));
            document.getElementById('p-'+pageId).classList.add('active-section');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            try { event.currentTarget.classList.add('active'); } catch(e){}
            
            if(pageId === 'users') this.renderUsers();
            if(pageId === 'my-result') this.renderCert();
            if(pageId === 'dashboard') this.updateDashboard();
        },

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
        addUser: function() {
            const name = document.getElementById('u-new-name').value;
            const user = document.getElementById('u-new-user').value;
            const pass = document.getElementById('u-new-pass').value;
            const role = document.getElementById('u-new-role').value;
            
            if(this.data.users.find(x => x.user === user)) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
            
            this.data.users.push({name, user, pass, role});
            this.save();
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
            this.renderUsers();
        },

        renderUsers: function() {
            const list = document.getElementById('users-list');
            list.innerHTML = this.data.users.map(u => 
                `<div style="background:#374151; padding:10px; margin:5px 0; border-radius:5px; display:flex; justify-content:space-between;">
                    <span>${u.name} (${u.role})</span>
                    <span style="color:#f59e0b">${u.user}</span>
                </div>`
            ).join('');
        },

        // --- Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ---
        saveGrade: function() {
            const st = document.getElementById('g-st').value;
            const sub = document.getElementById('g-sub').value;
            const scores = [1,2,3,4,5].map(i => document.getElementById('sc'+i).value);
            
            if(!this.data.grades[st]) this.data.grades[st] = {};
            this.data.grades[st][sub] = scores;
            this.save();
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        },

        addNote: function() {
            const st = document.getElementById('n-st').value;
            const txt = document.getElementById('n-txt').value;
            if(!st || !txt) return;

            if(!this.data.notes[st]) this.data.notes[st] = [];
            this.data.notes[st].push({
                writer: this.currentUser.name,
                text: txt,
                date: new Date().toLocaleDateString('ar-IQ')
            });
            this.save();
            alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³Ø¬Ù„');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (ØªØ¬Ø±ÙŠØ¨ÙŠ)
            const list = document.getElementById('notes-list');
            list.innerHTML = `<div class="note-card"><small>${new Date().toLocaleDateString()}</small><br>${txt}</div>` + list.innerHTML;
        },

        // --- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        setRoom: function(r) {
            if(r === 'staff' && this.currentUser.role === 'student') return alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­');
            this.currentRoom = r;
            document.getElementById('room-name').innerText = r === 'general' ? 'Ø§Ù„Ø¹Ø§Ù…Ø©' : (r === 'announce' ? 'Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª' : 'Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©');
            this.renderChat();
        },

        sendMsg: function() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            if(this.currentRoom === 'announce' && this.currentUser.role === 'student') return alert('Ù„Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ÙÙ‚Ø·');

            this.data.chats[this.currentRoom].push({
                user: this.currentUser.name,
                role: this.currentUser.role,
                text: txt,
                time: new Date().toLocaleTimeString('ar-IQ')
            });
            if(this.data.chats[this.currentRoom].length > 50) this.data.chats[this.currentRoom].shift();
            
            this.save();
            document.getElementById('chat-input').value = '';
            this.renderChat();
        },

        renderChat: function() {
            const div = document.getElementById('chat-display');
            div.innerHTML = (this.data.chats[this.currentRoom] || []).map(m => `
                <div class="msg ${m.user === this.currentUser.name ? 'me' : 'other'}">
                    <div style="font-size:0.7rem; opacity:0.7">${m.user}</div>
                    ${m.text}
                </div>
            `).join('');
            div.scrollTop = div.scrollHeight;
        },

        startChatLoop: function() {
            if(this.timer) clearInterval(this.timer);
            this.timer = setInterval(() => {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                const reloaded = JSON.parse(localStorage.getItem(DB_NAME));
                if(reloaded) {
                    this.data.chats = reloaded.chats;
                    this.renderChat();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    const anns = this.data.chats.announce;
                    if(anns && anns.length > 0) {
                        document.getElementById('latest-announce').innerText = anns[anns.length-1].text;
                    }
                }
            }, 2000);
        },

        // --- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ---
        renderCert: function() {
            const stName = this.currentUser.name;
            document.getElementById('cert-name').innerText = "Ø§Ù„Ø·Ø§Ù„Ø¨: " + stName;
            const grades = this.data.grades[stName] || {};
            const tbody = document.getElementById('cert-body');
            tbody.innerHTML = '';
            
            for(let sub in grades) {
                const g = grades[sub];
                let sum=0, c=0;
                g.forEach(v => {if(v){sum+=parseFloat(v); c++}});
                const avg = c>0 ? (sum/c).toFixed(1) : '-';
                tbody.innerHTML += `
                    <tr>
                        <td style="color:black">${sub}</td>
                        <td style="color:black">${g.join(' | ')}</td>
                        <td style="font-weight:bold; color:black">${avg}</td>
                    </tr>
                `;
            }

            const notes = this.data.notes[stName] || [];
            document.getElementById('cert-notes-area').innerHTML = notes.map(n => 
                `<div>- ${n.text} (${n.date})</div>`
            ).join('');
        },

        printCert: function() {
            html2pdf().from(document.getElementById('cert-print')).save('Cert.pdf');
        },

        updateDashboard: function() {
            // Ù…Ù†Ø·Ù‚ Ø¨Ø³ÙŠØ· Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„ (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡)
            // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ
            document.getElementById('top-student-name').innerText = "Ø¬Ø§Ø±Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...";
        },

        // --- Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ---
        exportData: function() {
            const jsonData = JSON.stringify(this.data);
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonData);
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            const filename = "shatt_backup_" + new Date().toISOString().replace(/[:.]/g,'-') + ".json";
            node.setAttribute("download", filename);
            document.body.appendChild(node);
            node.click();
            node.remove();

            // Ø±ÙØ¹ Ø¥Ù„Ù‰ Firebase Storage (Ù†Ø³Ø®Ø© Ø³Ø­Ø§Ø¨ÙŠØ©)
            try {
                const storageRef = ref(storage, 'backups/' + filename);
                // uploadString with 'raw' format
                uploadString(storageRef, jsonData, 'raw').then((snapshot) => {
                    return getDownloadURL(storageRef);
                }).then((url) => {
                    alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­:\n' + url);
                }).catch(err => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:', err);
                    alert('ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.');
                });
            } catch (e) {
                console.error('Firebase upload error', e);
            }
        },

        importData: function() {
            const file = document.getElementById('import-file').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    localStorage.setItem(DB_NAME, JSON.stringify(imported));
                    alert('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                    location.reload();
                } catch(err) {
                    alert('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
                }
            };
            reader.readAsText(file);
        },

        resetSystem: function() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡!')) {
                localStorage.removeItem(DB_NAME);
                location.reload();
            }
        }
    };

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    app.init();
    // expose globally for inline onclick handlers
    window.app = app;
</script>
</body>
</html>
