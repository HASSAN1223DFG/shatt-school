<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© V6.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --bg-dark: #111827; --sidebar: #1f2937; --primary: #d97706; --accent: #f59e0b; --text: #f3f4f6; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { margin: 0; background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        #login-overlay { position: fixed; inset: 0; z-index: 9999; background: radial-gradient(circle, #1f2937 0%, #000000 100%); display: flex; align-items: center; justify-content: center; }
        .login-card { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px; width: 400px; text-align: center; border: 1px solid var(--primary); backdrop-filter: blur(10px); }
        .sidebar { width: 280px; background: var(--sidebar); border-left: 1px solid #374151; display: flex; flex-direction: column; padding: 20px; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: var(--sidebar); border-bottom: 1px solid #374151; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .btn { background: linear-gradient(45deg, var(--primary), var(--accent)); color: black; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #374151; border: 1px solid #4b5563; color: white; border-radius: 8px; }
        .menu-item { padding: 12px; margin: 5px 0; border-radius: 10px; cursor: pointer; color: #9ca3af; display: flex; align-items: center; gap: 10px; }
        .menu-item.active { background: var(--primary); color: black; }
        .page-section { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .active-section { display: block; }
        .chat-box { height: calc(100% - 120px); overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid #334155; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 8px; max-width: 80%; width: fit-content; }
        .msg.me { background: var(--primary); color: black; margin-right: auto; }
        .msg.other { background: #374151; margin-left: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; color: black; }
        th, td { padding: 12px; border: 1px solid #000; text-align: center; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <i class="fas fa-graduation-cap fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
        <h2>Ù…Ø¯Ø§Ø±Ø³ Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨</h2>
        <input type="text" id="log-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="log-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn" onclick="appLogin()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
    </div>
</div>

<div id="app-container" style="display:none; width:100%; height:100%;">
    <div class="sidebar">
        <h3 id="u-name" style="color:var(--accent); text-align:center;">-</h3>
        <div class="menu-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="menu-item" onclick="nav('chat')"><i class="fas fa-comments"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div id="staff-menu" style="display:none;">
            <div class="menu-item" onclick="nav('grades')"><i class="fas fa-edit"></i> Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
        </div>
        <div id="student-menu" style="display:none;">
            <div class="menu-item" onclick="nav('my-result')"><i class="fas fa-certificate"></i> Ø´Ù‡Ø§Ø¯ØªÙŠ</div>
        </div>
        <button class="btn" onclick="location.reload()" style="background:#ef4444; margin-top:auto;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="main-content">
        <div class="top-bar"><h3 id="page-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3></div>
        
        <div id="p-dashboard" class="page-section active-section">
            <h1>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h1>
            <p>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.</p>
        </div>

        <div id="p-chat" class="page-section">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn" style="width:auto" onclick="setRoom('general')">Ø§Ù„Ø¹Ø§Ù…Ø©</button>
                <button class="btn" style="width:auto" onclick="setRoom('announce')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
            </div>
            <div id="chat-display" class="chat-box"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button class="btn" style="width:80px;" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <div id="p-grades" class="page-section">
            <h3>Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
            <input type="text" id="g-st" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
            <input type="number" id="sc1" placeholder="Ø´1">
            <input type="number" id="sc2" placeholder="Ø´2">
            <button class="btn" onclick="saveGrade()">Ø­ÙØ¸</button>
        </div>

        <div id="p-users" class="page-section">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <input type="text" id="u-new-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="text" id="u-new-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„">
            <input type="text" id="u-new-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <select id="u-new-role"><option value="student">Ø·Ø§Ù„Ø¨</option><option value="teacher">Ù…Ø¯Ø±Ø³</option></select>
            <button class="btn" onclick="addUser()">Ø¥Ù†Ø´Ø§Ø¡</button>
        </div>

        <div id="p-my-result" class="page-section">
            <div id="cert-print" style="background:white; color:black; padding:20px;">
                <h2 style="text-align:center;">Ù†ØªØ§Ø¦Ø¬ Ù…Ø¯Ø±Ø³Ø© Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨</h2>
                <h4 id="cert-name"></h4>
                <table id="res-table"><thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø´1</th><th>Ø´2</th></tr></thead><tbody id="res-body"></tbody></table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, child, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDjps8vgN3n-TlvJBUW87u_zjhkO_hxCJE",
        authDomain: "shatt-school.firebaseapp.com",
        databaseURL: "https://shatt-school-default-rtdb.firebaseio.com",
        projectId: "shatt-school",
        storageBucket: "shatt-school.firebasestorage.app",
        messagingSenderId: "484274570535",
        appId: "1:484274570535:web:8e780b61c5975ee8e2d502"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentUser = null;
    let currentRoom = 'general';

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù…
    window.appLogin = async function() {
        const u = document.getElementById('log-user').value;
        const p = document.getElementById('log-pass').value;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if(u === 'admin' && p === '951357094') {
            currentUser = {name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', role: 'admin', user: 'admin'};
            launchApp();
            return;
        }

        const snapshot = await get(ref(db, 'users'));
        if (snapshot.exists()) {
            const users = snapshot.val();
            for(let id in users) {
                if(users[id].user === u && users[id].pass === p) {
                    currentUser = users[id];
                    launchApp();
                    return;
                }
            }
        }
        alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©');
    }

    function launchApp() {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('u-name').innerText = currentUser.name;
        if(currentUser.role === 'admin' || currentUser.role === 'teacher') document.getElementById('staff-menu').style.display = 'block';
        if(currentUser.role === 'student') document.getElementById('student-menu').style.display = 'block';
        startChatSync();
    }

    window.nav = function(p) {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
        document.getElementById('p-'+p).classList.add('active-section');
        if(p === 'my-result') loadMyGrades();
    }

    window.addUser = function() {
        const userData = {
            name: document.getElementById('u-new-name').value,
            user: document.getElementById('u-new-user').value,
            pass: document.getElementById('u-new-pass').value,
            role: document.getElementById('u-new-role').value
        };
        push(ref(db, 'users'), userData);
        alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø­Ø§Ø¨Ø©');
    }

    window.saveGrade = function() {
        const st = document.getElementById('g-st').value;
        const data = { sc1: document.getElementById('sc1').value, sc2: document.getElementById('sc2').value };
        set(ref(db, 'grades/' + st), data);
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }

    window.setRoom = function(r) { currentRoom = r; startChatSync(); }

    window.sendMsg = function() {
        const txt = document.getElementById('chat-input').value;
        if(!txt) return;
        push(ref(db, 'chats/' + currentRoom), {
            user: currentUser.name,
            text: txt,
            time: new Date().toLocaleTimeString()
        });
        document.getElementById('chat-input').value = '';
    }

    function startChatSync() {
        onValue(ref(db, 'chats/' + currentRoom), (snapshot) => {
            const data = snapshot.val();
            const div = document.getElementById('chat-display');
            div.innerHTML = '';
            for(let id in data) {
                const m = data[id];
                div.innerHTML += `<div class="msg ${m.user === currentUser.name ? 'me' : 'other'}"><b>${m.user}:</b> ${m.text}</div>`;
            }
            div.scrollTop = div.scrollHeight;
        });
    }

    function loadMyGrades() {
        document.getElementById('cert-name').innerText = currentUser.name;
        onValue(ref(db, 'grades/' + currentUser.name), (snapshot) => {
            const g = snapshot.val();
            const body = document.getElementById('res-body');
            body.innerHTML = g ? `<tr><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¹Ø§Ù…</td><td>${g.sc1}</td><td>${g.sc2}</td></tr>` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ø¨Ø¹Ø¯';
        });
    }
</script>
</body>
</html>
