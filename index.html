<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة شط العرب السحابية V7.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg-dark: #111827; --sidebar: #1f2937; --primary: #d97706; --accent: #f59e0b; --text: #f3f4f6; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { margin: 0; background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        #login-overlay { position: fixed; inset: 0; z-index: 9999; background: radial-gradient(circle, #1f2937 0%, #000000 100%); display: flex; align-items: center; justify-content: center; }
        .login-card { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px; width: 400px; text-align: center; border: 1px solid var(--primary); backdrop-filter: blur(10px); }
        .sidebar { width: 280px; background: var(--sidebar); border-left: 1px solid #374151; display: flex; flex-direction: column; padding: 20px; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: var(--sidebar); border-bottom: 1px solid #374151; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .btn { background: linear-gradient(45deg, var(--primary), var(--accent)); color: black; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #374151; border: 1px solid #4b5563; color: white; border-radius: 8px; }
        .menu-item { padding: 12px; margin: 5px 0; border-radius: 10px; cursor: pointer; color: #9ca3af; display: flex; align-items: center; gap: 10px; }
        .menu-item.active { background: var(--primary); color: black; }
        .page-section { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .active-section { display: block; }
        .chat-box { height: calc(100% - 130px); overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid #334155; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 8px; max-width: 80%; width: fit-content; background: #374151; }
        .msg.me { background: var(--primary); color: black; margin-right: auto; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <i class="fas fa-graduation-cap fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
        <h2>مدارس شط العرب</h2>
        <input type="text" id="log-user" placeholder="اسم المستخدم">
        <input type="password" id="log-pass" placeholder="كلمة المرور">
        <button class="btn" onclick="appLogin()">دخول آمن (سحابي)</button>
    </div>
</div>

<div id="app-container" style="display:none; width:100%; height:100%;">
    <div class="sidebar">
        <h3 id="display-name" style="color:var(--accent); text-align:center;">-</h3>
        <div class="menu-item active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> الرئيسية</div>
        <div class="menu-item" onclick="showPage('chat')"><i class="fas fa-comments"></i> الدردشة</div>
        <div id="staff-controls" style="display:none;">
            <div class="menu-item" onclick="showPage('grades')"><i class="fas fa-edit"></i> رصد الدرجات</div>
            <div class="menu-item" onclick="showPage('users')"><i class="fas fa-users-cog"></i> الحسابات</div>
        </div>
        <div id="student-controls" style="display:none;">
            <div class="menu-item" onclick="showPage('result')"><i class="fas fa-certificate"></i> شهادتي</div>
        </div>
        <button class="btn" onclick="location.reload()" style="background:#ef4444; margin-top:auto;">خروج</button>
    </div>

    <div class="main-content">
        <div class="top-bar"><h3 id="page-title">الرئيسية</h3> <small id="sync-status">متصل سحابياً ✅</small></div>
        
        <div id="p-dashboard" class="page-section active-section">
            <h1>أهلاً بك في النسخة السحابية المحدثة</h1>
            <p>البيانات تظهر الآن في جميع الأجهزة فوراً.</p>
        </div>

        <div id="p-chat" class="page-section">
            <div id="chat-window" class="chat-box"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="msg-input" placeholder="اكتب رسالة...">
                <button class="btn" style="width:80px; margin:0" onclick="sendMessage()">إرسال</button>
            </div>
        </div>

        <div id="p-grades" class="page-section">
            <h3>رصد درجات الطالب</h3>
            <input type="text" id="grade-st-name" placeholder="اسم الطالب الثلاثي">
            <input type="number" id="grade-val" placeholder="الدرجة">
            <button class="btn" onclick="saveGrade()">حفظ الدرجة</button>
        </div>

        <div id="p-users" class="page-section">
            <h3>إنشاء حساب جديد</h3>
            <input type="text" id="new-name" placeholder="الاسم الكامل">
            <input type="text" id="new-user" placeholder="اسم الدخول">
            <input type="text" id="new-pass" placeholder="كلمة المرور">
            <select id="new-role"><option value="student">طالب</option><option value="teacher">مدرس</option></select>
            <button class="btn" onclick="createNewUser()">إنشاء الحساب</button>
        </div>

        <div id="p-result" class="page-section">
            <h3>نتيجتي الدراسية</h3>
            <div id="my-grade-display" style="font-size: 2rem; background:white; color:black; padding:20px; text-align:center; border-radius:10px;">
                جاري جلب الدرجة...
            </div>
        </div>
    </div>
</div>

<script>
    // إعدادات Firebase الخاصة بك
    const firebaseConfig = {
        apiKey: "AIzaSyDjps8vgN3n-TlvJBUW87u_zjhkO_hxCJE",
        authDomain: "shatt-school.firebaseapp.com",
        databaseURL: "https://shatt-school-default-rtdb.firebaseio.com",
        projectId: "shatt-school",
        storageBucket: "shatt-school.firebasestorage.app",
        messagingSenderId: "484274570535",
        appId: "1:484274570535:web:8e780b61c5975ee8e2d502"
    };

    // بدء تشغيل Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    let userSession = null;

    // تسجيل الدخول
    window.appLogin = function() {
        const u = document.getElementById('log-user').value;
        const p = document.getElementById('log-pass').value;

        if(u === 'admin' && p === '951357094') {
            userSession = { name: "المدير العام", role: "admin" };
            enterApp();
        } else {
            database.ref('users').once('value').then((snapshot) => {
                let found = false;
                snapshot.forEach((child) => {
                    const val = child.val();
                    if(val.user === u && val.pass === p) {
                        userSession = val;
                        found = true;
                        enterApp();
                    }
                });
                if(!found) alert("خطأ في البيانات");
            });
        }
    };

    function enterApp() {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('display-name').innerText = userSession.name;
        
        if(userSession.role === 'admin' || userSession.role === 'teacher') {
            document.getElementById('staff-controls').style.display = 'block';
        } else {
            document.getElementById('student-controls').style.display = 'block';
        }
        syncChat();
    }

    window.showPage = function(p) {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
        document.getElementById('p-'+p).classList.add('active-section');
        if(p === 'result') fetchMyGrade();
    };

    // وظائف السحابة
    window.createNewUser = function() {
        const data = {
            name: document.getElementById('new-name').value,
            user: document.getElementById('new-user').value,
            pass: document.getElementById('new-pass').value,
            role: document.getElementById('new-role').value
        };
        database.ref('users').push(data);
        alert("تم الحفظ في السحابة بنجاح ✅");
    };

    window.saveGrade = function() {
        const name = document.getElementById('grade-st-name').value;
        const val = document.getElementById('grade-val').value;
        database.ref('grades/' + name).set({ grade: val });
        alert("تم تحديث الدرجة سحابياً ✅");
    };

    window.sendMessage = function() {
        const txt = document.getElementById('msg-input').value;
        if(txt) {
            database.ref('chat').push({
                user: userSession.name,
                text: txt
            });
            document.getElementById('msg-input').value = '';
        }
    };

    function syncChat() {
        database.ref('chat').on('value', (snapshot) => {
            const win = document.getElementById('chat-window');
            win.innerHTML = '';
            snapshot.forEach((child) => {
                const m = child.val();
                win.innerHTML += `<div class="msg ${m.user === userSession.name ? 'me' : ''}"><b>${m.user}:</b> ${m.text}</div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function fetchMyGrade() {
        database.ref('grades/' + userSession.name).on('value', (snapshot) => {
            const data = snapshot.val();
            document.getElementById('my-grade-display').innerText = data ? "درجتك هي: " + data.grade : "لم ترصد درجتك بعد";
        });
    }
</script>
</body>
</html>
