<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #111827;
            --sidebar: #1f2937;
            --primary: #d97706;
            --accent: #f59e0b;
            --text: #f3f4f6;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { margin: 0; background: var(--bg-dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle, #1f2937 0%, #000000 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px;
            width: 400px; text-align: center; border: 1px solid var(--primary);
            backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(217, 119, 6, 0.2);
        }

        /* Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .sidebar { width: 280px; background: var(--sidebar); border-left: 1px solid #374151; display: flex; flex-direction: column; padding: 20px; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: var(--sidebar); border-bottom: 1px solid #374151; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }

        .btn { background: linear-gradient(45deg, var(--primary), var(--accent)); color: black; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #374151; border: 1px solid #4b5563; color: white; border-radius: 8px; outline: none; }
        
        .menu-item { padding: 12px; margin: 5px 0; border-radius: 10px; cursor: pointer; color: #9ca3af; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: black; }

        .page-section { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .active-section { display: block; }

        /* Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-box { height: calc(100% - 130px); overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid #334155; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 8px; max-width: 80%; width: fit-content; font-size: 0.9rem; position: relative; }
        .msg.me { background: var(--primary); color: black; margin-right: auto; }
        .msg.other { background: #374151; margin-left: auto; }
        .msg b { display: block; font-size: 0.7rem; margin-bottom: 3px; opacity: 0.8; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; color: black; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background: #eee; }

        .note-card { background: #374151; padding: 10px; margin-bottom: 10px; border-radius: 8px; border-right: 4px solid var(--primary); }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <i class="fas fa-graduation-cap fa-4x" style="color:var(--primary); margin-bottom:15px;"></i>
        <h2 style="margin-bottom:20px;">Ù…Ø¯Ø§Ø±Ø³ Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨</h2>
        <input type="text" id="log-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="log-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn" onclick="appLogin()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
    </div>
</div>

<div id="app-container" style="display:none; width:100%; height:100%;">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px;">
            <h3 id="u-name" style="color:var(--accent); margin-bottom:5px;">-</h3>
            <span id="u-role" style="font-size:0.8rem; background:#374151; padding:2px 8px; border-radius:10px;">-</span>
        </div>
        <div class="menu-item active" onclick="nav('dashboard')"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="menu-item" onclick="nav('chat')"><i class="fas fa-comments"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        
        <div id="staff-menu" style="display:none;">
            <div class="menu-item" onclick="nav('grades')"><i class="fas fa-edit"></i> Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
            <div class="menu-item" onclick="nav('notes')"><i class="fas fa-sticky-note"></i> Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
        </div>

        <div id="student-menu" style="display:none;">
            <div class="menu-item" onclick="nav('my-result')"><i class="fas fa-certificate"></i> Ø´Ù‡Ø§Ø¯ØªÙŠ</div>
        </div>

        <button class="btn" onclick="location.reload()" style="background:#ef4444; margin-top:auto;"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="main-content">
        <div class="top-bar"><h3 id="page-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3><i class="fas fa-wifi" id="online-status" style="color:green"></i></div>
        
        <div id="p-dashboard" class="page-section active-section">
            <h1>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h1>
            <div style="background:var(--sidebar); padding:20px; border-radius:15px; margin-top:20px;">
                <h3>ğŸ“¢ Ø¢Ø®Ø± Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</h3>
                <div id="latest-ann" style="opacity:0.8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>

        <div id="p-chat" class="page-section">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn" style="width:auto" onclick="setRoom('general')">Ø§Ù„Ø¹Ø§Ù…Ø©</button>
                <button class="btn" style="width:auto" onclick="setRoom('announce')">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</button>
                <button class="btn" id="staff-chat-btn" style="width:auto; display:none" onclick="setRoom('staff')">ØºØ±ÙØ© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</button>
            </div>
            <h4 id="room-display">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
            <div id="chat-display" class="chat-box"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button class="btn" style="width:80px; margin:0" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="p-grades" class="page-section">
            <h3>Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
            <input type="text" id="g-st" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            <select id="g-sub">
                <option>Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ</option><option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                <option>ÙÙŠØ²ÙŠØ§Ø¡</option><option>ÙƒÙŠÙ…ÙŠØ§Ø¡</option><option>Ø£Ø­ÙŠØ§Ø¡</option><option>Ø­Ø§Ø³ÙˆØ¨</option>
            </select>
            <div style="display:grid; grid-template-columns: repeat(5,1fr); gap:5px;">
                <input type="number" id="sc1" placeholder="Ø´1"><input type="number" id="sc2" placeholder="Ø´2">
                <input type="number" id="sc3" placeholder="Ù†ØµÙ"><input type="number" id="sc4" placeholder="Ù2-1">
                <input type="number" id="sc5" placeholder="Ù2-2">
            </div>
            <button class="btn" onclick="saveGrade()">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
        </div>

        <div id="p-notes" class="page-section">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„ÙˆÙƒÙŠØ©</h3>
            <input type="text" id="n-st" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
            <textarea id="n-txt" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ù†Ø§..."></textarea>
            <button class="btn" onclick="saveNote()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        </div>

        <div id="p-users" class="page-section">
            <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="u-new-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="text" id="u-new-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„">
            <input type="text" id="u-new-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <select id="u-new-role"><option value="student">Ø·Ø§Ù„Ø¨</option><option value="teacher">Ù…Ø¯Ø±Ø³</option></select>
            <button class="btn" onclick="addUser()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹</button>
            <div id="users-list" style="margin-top:20px;"></div>
        </div>

        <div id="p-my-result" class="page-section">
            <div id="cert-print" style="background:white; color:black; padding:30px; border:10px double var(--primary);">
                <div style="text-align:center; border-bottom:2px solid black;">
                    <h2>Ù…Ø¯Ø§Ø±Ø³ Ø´Ø· Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</h2>
                    <p>ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© 2026</p>
                </div>
                <h3 id="cert-name-label" style="margin-top:20px;">Ø§Ù„Ø·Ø§Ù„Ø¨: </h3>
                <table id="cert-table">
                    <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø´1</th><th>Ø´2</th><th>Ù†ØµÙ</th><th>Ù2-1</th><th>Ù2-2</th><th>Ø§Ù„Ù…Ø¹Ø¯Ù„</th></tr></thead>
                    <tbody id="cert-body"></tbody>
                </table>
                <div id="cert-notes" style="margin-top:20px;"></div>
            </div>
            <button class="btn" onclick="printCert()">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ±Ø¨ÙŠØ² Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
    const firebaseConfig = {
        apiKey: "AIzaSyDjps8vgN3n-TlvJBUW87u_zjhkO_hxCJE",
        authDomain: "shatt-school.firebaseapp.com",
        databaseURL: "https://shatt-school-default-rtdb.firebaseio.com",
        projectId: "shatt-school",
        storageBucket: "shatt-school.firebasestorage.app",
        messagingSenderId: "484274570535",
        appId: "1:484274570535:web:8e780b61c5975ee8e2d502"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentUser = null;
    let currentRoom = 'general';

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    window.appLogin = async function() {
        const u = document.getElementById('log-user').value;
        const p = document.getElementById('log-pass').value;

        if(u === 'admin' && p === '951357094') {
            currentUser = {name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', role: 'admin', user: 'admin'};
            launchApp();
            return;
        }

        const snapshot = await get(ref(db, 'users'));
        if (snapshot.exists()) {
            const users = snapshot.val();
            for(let id in users) {
                if(users[id].user === u && users[id].pass === p) {
                    currentUser = users[id];
                    launchApp();
                    return;
                }
            }
        }
        alert('Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    };

    function launchApp() {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('u-name').innerText = currentUser.name;
        document.getElementById('u-role').innerText = currentUser.role;

        if(currentUser.role === 'admin' || currentUser.role === 'teacher') {
            document.getElementById('staff-menu').style.display = 'block';
            document.getElementById('staff-chat-btn').style.display = 'block';
        }
        if(currentUser.role === 'student') document.getElementById('student-menu').style.display = 'block';
        
        syncData();
    }

    window.nav = function(p) {
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active-section'));
        document.getElementById('p-'+p).classList.add('active-section');
        document.getElementById('page-title').innerText = p.toUpperCase();
        if(p === 'my-result') loadResult();
        if(p === 'users') listUsers();
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    window.addUser = function() {
        const data = {
            name: document.getElementById('u-new-name').value,
            user: document.getElementById('u-new-user').value,
            pass: document.getElementById('u-new-pass').value,
            role: document.getElementById('u-new-role').value
        };
        push(ref(db, 'users'), data);
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹');
        listUsers();
    };

    function listUsers() {
        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('users-list');
            list.innerHTML = '';
            const data = snap.val();
            for(let id in data) {
                list.innerHTML += `<div class="note-card">${data[id].name} - ${data[id].role} (${data[id].user})</div>`;
            }
        });
    }

    // Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    window.saveGrade = function() {
        const st = document.getElementById('g-st').value;
        const sub = document.getElementById('g-sub').value;
        const grades = [
            document.getElementById('sc1').value, document.getElementById('sc2').value,
            document.getElementById('sc3').value, document.getElementById('sc4').value,
            document.getElementById('sc5').value
        ];
        set(ref(db, `grades/${st}/${sub}`), grades);
        alert('ØªÙ… Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø©');
    };

    window.saveNote = function() {
        const st = document.getElementById('n-st').value;
        const txt = document.getElementById('n-txt').value;
        push(ref(db, `notes/${st}`), {text: txt, date: new Date().toLocaleDateString()});
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
    };

    // Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
    function loadResult() {
        const st = currentUser.name;
        document.getElementById('cert-name-label').innerText = "Ø§Ù„Ø·Ø§Ù„Ø¨: " + st;
        onValue(ref(db, `grades/${st}`), (snap) => {
            const body = document.getElementById('cert-body');
            body.innerHTML = '';
            const data = snap.val();
            for(let sub in data) {
                const g = data[sub];
                let sum=0, count=0;
                g.forEach(v => { if(v) { sum+=parseFloat(v); count++; }});
                const avg = count>0 ? (sum/count).toFixed(1) : '-';
                body.innerHTML += `<tr><td>${sub}</td><td>${g[0]}</td><td>${g[1]}</td><td>${g[2]}</td><td>${g[3]}</td><td>${g[4]}</td><td>${avg}</td></tr>`;
            }
        });
        onValue(ref(db, `notes/${st}`), (snap) => {
            const div = document.getElementById('cert-notes');
            div.innerHTML = '<b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</b><br>';
            const data = snap.val();
            for(let id in data) { div.innerHTML += `- ${data[id].text} (${data[id].date})<br>`; }
        });
    }

    window.printCert = function() { html2pdf().from(document.getElementById('cert-print')).save('Shatt_Result.pdf'); };

    // Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©
    window.setRoom = function(r) { 
        currentRoom = r; 
        document.getElementById('room-display').innerText = r === 'general' ? 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©' : (r === 'announce' ? 'Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª' : 'ØºØ±ÙØ© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©');
        syncData(); 
    };

    window.sendMsg = function() {
        const txt = document.getElementById('chat-input').value;
        if(!txt) return;
        if(currentRoom === 'announce' && currentUser.role === 'student') return alert('Ù„Ù„ÙƒØ§Ø¯Ø± ÙÙ‚Ø·');
        push(ref(db, `chats/${currentRoom}`), {user: currentUser.name, text: txt});
        document.getElementById('chat-input').value = '';
    };

    function syncData() {
        onValue(ref(db, `chats/${currentRoom}`), (snap) => {
            const div = document.getElementById('chat-display');
            div.innerHTML = '';
            const data = snap.val();
            for(let id in data) {
                div.innerHTML += `<div class="msg ${data[id].user === currentUser.name ? 'me' : 'other'}"><b>${data[id].user}</b>${data[id].text}</div>`;
            }
            div.scrollTop = div.scrollHeight;
        });
        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ¨Ù„ÙŠØº ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        onValue(ref(db, 'chats/announce'), (snap) => {
            const data = snap.val();
            if(data) {
                const last = Object.values(data).pop();
                document.getElementById('latest-ann').innerText = last.text;
            }
        });
    }
</script>
</body>
</html>
